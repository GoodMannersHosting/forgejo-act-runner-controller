# Build stage for the controller binary
FROM golang:1.24 AS builder
ARG TARGETOS
ARG TARGETARCH

WORKDIR /workspace

# Install UPX for binary compression
RUN apt-get update && apt-get install -y upx && rm -rf /var/lib/apt/lists/*

# Copy go mod files
COPY go.mod go.mod
COPY go.sum go.sum

# Download dependencies
RUN go mod download

# Copy source code
COPY . .

# Build the controller binary
RUN CGO_ENABLED=0 GOOS=${TARGETOS:-linux} GOARCH=${TARGETARCH} \
    go build -a -ldflags="-w -s" -o manager cmd/main.go

# Compress the binary with UPX
RUN upx --best --lzma -q manager || true

# Final stage - scratch image
FROM scratch
WORKDIR /

# Copy the compressed binary from builder
COPY --from=builder /workspace/manager /manager

# Note: Cannot set USER in scratch image (no /etc/passwd)
# The binary runs as root, but is statically linked and minimal

ENTRYPOINT ["/manager"]

