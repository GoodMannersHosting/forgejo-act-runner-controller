apiVersion: forgejo.actions.io/v1alpha1
kind: ActDeployment
metadata:
  labels:
    app.kubernetes.io/name: forgejo-act-runner-controller
    app.kubernetes.io/managed-by: kustomize
  name: actdeployment-sample
  namespace: default
spec:
  # Forgejo server URL
  forgejoServer: "https://git.cloud.danmanners.com"

  # Organization name to monitor for jobs
  organization: "demo-organization"

  # Label filter for jobs (e.g., "docker" or "ubuntu-22.04:docker://node:20-bullseye")
  labels: "docker"

  # Reference to the Secret containing the Forgejo API token
  tokenSecretRef:
    name: forgejo-token
    namespace: default

  # Polling interval for the listener pod (defaults to 10s if not specified)
  pollInterval: "10s"

  # Optional: Min and Max runner count limits
  # minRunners: 0  # Minimum number of ActRunner resources to maintain (defaults to 0)
  # maxRunners: 10 # Maximum number of ActRunner resources that can be created concurrently (0 means unlimited, defaults to 0)

  # Optional: Customize the listener pod template
  listenerTemplate:
    spec:
      dnsPolicy: ClusterFirstWithHostNet
      hostAliases:
        - ip: "172.31.0.10"
          hostnames:
            - "git.cloud.danmanners.com"
      containers:
        - name: listener
          image: harbor.cloud.danmanners.com/library/farc/listener:0.1.10
          command: ["/listener"]
          env:
            # Skip TLS verification for self-signed/internal CA certificates
            - name: SKIP_TLS_VERIFY
              value: "true"
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi

  # Optional: Default runner container image (used if runnerTemplate doesn't specify an image)
  runnerImage: "harbor.cloud.danmanners.com/library/farc/act-runner:0.0.4"

  # Optional: Docker-in-Docker sidecar image (defaults to docker.io/library/docker:29.1.3-dind-alpine3.23)
  dockerInDockerImage: "docker.io/library/docker:29.1.3-dind-alpine3.23"

  # Optional: Customize the runner pod template (used by ActRunner to create Kubernetes Pods)
  # If runnerTemplate is not specified, the runnerImage will be used as the default container image
  runnerTemplate:
    spec:
      dnsPolicy: ClusterFirstWithHostNet
      hostAliases:
        - ip: "172.31.0.10"
          hostnames:
            - "git.cloud.danmanners.com"

  #     containers:
  #     - name: runner
  #       image: harbor.cloud.danmanners.com/library/forgejo-act-runner/runner:0.1.0
  #       resources:
  #         requests:
  #           cpu: 500m
  #           memory: 512Mi
  #         limits:
  #           cpu: 2000m
  #           memory: 2Gi
